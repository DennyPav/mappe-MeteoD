name: ERA5 monthly PNG upload

on:
  schedule:
    - cron: "0 6 7 * *"   # 7 del mese alle 06:00 UTC
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      # --- 1. Checkout repository ---
      - uses: actions/checkout@v4

      # --- 2. Setup Python ---
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # --- 3. System dependencies ---
      - name: System deps
        run: |
          sudo apt-get update
          sudo apt-get install -y libgeos-dev libproj-dev

      # --- 4. Python dependencies ---
      - name: Python deps
        run: |
          pip install numpy xarray netCDF4 geopandas matplotlib cartopy cdsapi

      # --- 5. Configure CDS API ---
      - name: Configure CDS API
        env:
          CDS_API_URL: ${{ secrets.CDS_API_URL }}
          CDS_API_KEY: ${{ secrets.CDS_API_KEY }}
        run: |
          printf "url: %s\nkey: %s\n" "$CDS_API_URL" "$CDS_API_KEY" > ~/.cdsapirc

      # --- 6. Run ERA5 script ---
      - name: Run script (generates PNG)
        run: |
          python era5_monthly_analysis.py

      # --- 7. Install rclone ---
      - name: Install rclone
        run: |
          curl https://rclone.org/install.sh | sudo bash

      # --- 8. Write rclone.conf from secret ---
      - name: Write rclone.conf from secret
        env:
          RCLONE_CONF_B64: ${{ secrets.RCLONE_CONF_B64 }}
        run: |
          mkdir -p ~/.config/rclone
          echo "$RCLONE_CONF_B64" | base64 -d > ~/.config/rclone/rclone.conf

      # --- 9. Upload PNG to Google Drive ---
      - name: Upload only the two PNG with rclone
        env:
          ERA5_FOLDER_ID: ${{ secrets.ERA5_FOLDER }}  # solo l'ID della cartella Drive
        run: |
          set -e

          # Rimuove eventuali newline dal secret
          ERA5_FOLDER_ID=$(echo "$ERA5_FOLDER_ID" | tr -d '\n')

          # Nome del remote definito nel rclone.conf
          REMOTE_NAME="gd_personal"

          # File PNG da caricare
          TEMP_FILE=$(find data/plot_mensili_era5_only -type f -name "temperatura_*.png" | sort -nr | head -1)
          PREC_FILE=$(find data/plot_mensili_era5_only -type f -name "precipitazione_*.png" | sort -nr | head -1)

          echo "TEMP_FILE=$TEMP_FILE"
          echo "PREC_FILE=$PREC_FILE"
          echo "UPLOAD su cartella ID: $ERA5_FOLDER_ID sul remote $REMOTE_NAME"

          # Upload su Google Drive usando solo l'ID della cartella
          rclone copy "$TEMP_FILE" "$REMOTE_NAME:" --drive-root-folder-id "$ERA5_FOLDER_ID" --config ~/.config/rclone/rclone.conf -v
          rclone copy "$PREC_FILE" "$REMOTE_NAME:" --drive-root-folder-id "$ERA5_FOLDER_ID" --config ~/.config/rclone/rclone.conf -v
