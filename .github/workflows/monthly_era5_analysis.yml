name: ERA5 monthly PNG upload

on:
  schedule:
    - cron: "0 6 7 * *"   # 7 del mese alle 06:00 UTC
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: System deps
        run: |
          sudo apt-get update
          sudo apt-get install -y libgeos-dev libproj-dev

      - name: Python deps
        run: |
          pip install numpy xarray netCDF4 geopandas matplotlib cartopy cdsapi

      - name: Configure CDS API
        env:
          CDS_API_URL: ${{ secrets.CDS_API_URL }}
          CDS_API_KEY: ${{ secrets.CDS_API_KEY }}
        run: |
          printf "url: %s\nkey: %s\n" "$CDS_API_URL" "$CDS_API_KEY" > ~/.cdsapirc

      - name: Run script (generates PNG)
        run: |
          python era5_monthly_analysis.py

      - name: Install rclone
        run: |
          curl https://rclone.org/install.sh | sudo bash

      - name: Write rclone.conf from secret
        env:
          RCLONE_CONF_B64: ${{ secrets.RCLONE_CONF_B64 }}
        run: |
          mkdir -p ~/.config/rclone
          echo "$RCLONE_CONF_B64" | base64 -d > ~/.config/rclone/rclone.conf

      - name: Upload only the two PNG with rclone
        env:
          ERA5_FOLDER: ${{ secrets.ERA5_FOLDER }}
        run: |
          set -e

          TEMP_FILE=$(find data/plot_mensili_era5_only -type f -name "temperatura_*.png" -printf "%T@ %p\n" | sort -nr | head -1 | cut -d' ' -f2-)
          PREC_FILE=$(find data/plot_mensili_era5_only -type f -name "precipitazione_*.png" -printf "%T@ %p\n" | sort -nr | head -1 | cut -d' ' -f2-)

          echo "TEMP_FILE=$TEMP_FILE"
          echo "PREC_FILE=$PREC_FILE"
          echo "DEST=$ERA5_FOLDER"

          rclone copy "$TEMP_FILE" "$ERA5_FOLDER" --config ~/.config/rclone/rclone.conf -v
          rclone copy "$PREC_FILE" "$ERA5_FOLDER" --config ~/.config/rclone/rclone.conf -v
